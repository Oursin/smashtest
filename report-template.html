<html>
    <head>
        <meta name="treeObj" content="{{{treeObj}}}"/>
        <meta name="runnerObj" content="{{{runnerObj}}}"/>
        <meta name="reportTime" content="{{{reportTime}}}"/>

        <script src="https://unpkg.com/popper.js@1"></script>
        <script src="https://unpkg.com/tippy.js@4"></script>

        <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
        <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

        <style>
            body {
                background-color: black;
                color: white;
                font-family: Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
                margin: 0;
                padding: 0;
                overflow-y: hidden;
            }

            .header {
                font-size: 16px;
                margin: 0 0 10px 6px;
            }

            .divider-pane {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 50%;
                height: 100%;
                vertical-align: top;
                border: 0;
                margin: 0;
                overflow-x: auto;
                padding: 6px 4px;
            }

            .tree-pane {
                left: 0;
                padding-right: 0;
            }

            .preview-pane {
                right: 0;
                padding-left: 10px;
                background-color: rgb(40,40,40);
            }

            .tree-header {
                margin: 0 0 20px 0;
            }

            .tree-header-container {
                margin: 0 0 0 10px;
                font-size: 13px;
            }

            .branch-list {
                margin: 0 0 30px 0;
            }

            .none-indicator {
                font-size: 14px;
                color: rgb(100,100,100);
                padding-left: 40px;
            }

            .branch {
                margin-bottom: 12px;
                margin-left: 2px;
                position: relative;
            }

            .branch.active {
                background-color: rgb(40,40,40);
            }

            .branch.hover {
                background-color: rgb(40,40,40);
                /*background-color: rgb(70,70,70);*/
            }

            .branch-indicator {
                display: inline-block;
                position: absolute;
                top: 0;
                left: 0;
                width: 10px;
                height: 100%;
                min-width: 10px;
                border: 0;
                margin: 0;
                padding: 0;
            }

            .branch-indicator:hover {
                cursor: pointer;
            }

            .branch-indicator.notrunyet {
                background-color: gray;
            }

            .branch-indicator.running {
                background-color: orange;
                animation: blinker 2s linear infinite;
            }

            @keyframes blinker {
                50% {
                    opacity: 0.3;
                }
            }

            .branch-indicator.passed {
                background-color: green;
            }

            .branch-indicator.failed {
                background-color: red;
            }

            .branch-indicator.skipped {
                background-color: rgb(0,200,200);
            }

            .branch-contents {
                display: inline-block;
                width: 100%;
                border: 0;
                margin: 0;
                padding-left: 10px;
                padding-right: 0;
            }

            .line {
                font-size: 14px;
                position: relative;
                white-space: nowrap;
                cursor: pointer;
            }

            .line.active {
                background-color: rgb(40,40,40);
            }

            .line:hover {
                background-color: rgb(40,40,40);
                /*background-color: rgb(70,70,70);*/
            }

            .line .content {
                display: inline-block;
            }

            .line .filelocation {
                visibility: hidden;
                display: inline-block;
                vertical-align: top;
                color: rgb(130,130,130);
                padding: 0 15px;
                font-size: 13px;
            }

            .line:hover .filelocation {
                visibility: visible;
            }

            .pill {
                position: relative;
                top: -2px;
                color: white;
                padding: 1px 3px;
                border-radius: 5px;
                font-size: 11px;
            }

            .pill.expected {
                background-color: green;
            }

            .pill.unexpected {
                background-color: red;
            }

            .pill.skipped {
                background-color: rgb(0,200,200);
            }

            .pill.running {
                background-color: orange;
            }

            .tooltip-text {
                font-size: 12px;
            }

            .progress-bar {
                height: 20px;
                margin-right: 10px;
                padding: 0;
            }

            .progress-bar .filled-bar {
                background-color: rgb(245,155,0);
                color: white;
                text-align: center;
                height: 100%;
                overflow-x: hidden;
            }

            .progress-bar .filled-bar-text {
                position: relative;
                top: 2px;
                padding: 0 5px;
            }

            .msg {
                color: rgb(100,100,100);
                font-size: 12px;
                font-weight: normal;
            }

            .refresh-msg {
                white-space: nowrap;
            }

            .refresh-msg:hover {
                cursor: pointer;
                filter: brightness(1.75);
            }

            .refresh-icon {
                width: 14px;
                vertical-align: bottom;
            }

            .tree-header-item {
                margin-bottom: 10px;
            }

            .notrunyet-item {
                color: gray;
            }

            .running-item {
                color: orange;
                animation: blinker 2s linear infinite;
            }

            .running-item-no-anim {
                color: orange;
            }

            .passed-item {
                color: rgb(0,200,0);
            }

            .failed-item {
                color: red;
            }

            .skipped-item {
                color: rgb(0,200,200);
            }

            .counts {
                line-height: 16px;
            }

            .line-number {
                color: rgb(100,100,100);
                font-size: 11px;
                display: inline-block;
                vertical-align: top;
                position: relative;
                top: 2px;
                margin-left: 8px;
            }

            .vertical-line-container {
                border-left: 1px dashed rgb(100,100,100);
                margin-left: 4px;
                padding-left: 8px;
                display: inline-block;
            }

            .line > .vertical-line-container {
                position: relative;
                top: 1px;
                margin-bottom: 1px;
            }

            .stacktrace {
                padding: 5px 0 20px 30px;
                color: white;
                font-size: 12px;
            }

            .logs {
                padding: 5px 0 20px 30px;
                color: white;
                font-size: 12px;
            }

            .thumbs-up {
                cursor: default;
            }

            .preview-pane .preview-name .filelocation {
                color: rgb(130,130,130);
                font-size: 12px;
            }

            .preview-pane .preview-name .elapsed {
                color: rgb(130,130,130);
                font-size: 12px;
            }

            .preview-pane .preview-state {
                margin-left: 20px;
                margin-bottom: 20px;
                font-size: 13px;
            }

            .step-report {
                margin: 20px;
            }

            .preview-pane-msg {
                color: rgb(90,90,90);
                font-size: 16px;
                height: 100%;
                padding-top: 70px;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            class App extends React.Component {
                constructor() {
                    super();

                    this.state = {
                        tree: null,
                        runner: null,
                        reportTime: null,
                        previewed: null
                    };

                    // Parse in tree
                    let treeContent = document.querySelector("meta[name=treeObj]").getAttribute("content");
                    let treeJSON = this.unescapeHtml(treeContent);
                    if(!treeJSON.startsWith("\{\{\{")) {
                        this.state.tree = JSON.parse(treeJSON);
                    }

                    // Parse in runner
                    let runnerContent = document.querySelector("meta[name=runnerObj]").getAttribute("content");
                    let runnerJSON = this.unescapeHtml(runnerContent);
                    if(!runnerJSON.startsWith("\{\{\{")) {
                        this.state.runner = JSON.parse(runnerJSON);
                    }

                    // Parse in reportTime
                    this.state.reportTime = document.querySelector("meta[name=reportTime]").getAttribute("content");

                    this.onChangePreview = this.onChangePreview.bind(this);
                }

                unescapeHtml(str) {
                    return str
                        .replace(/&#039;/g, "'")
                        .replace(/&quot;/g, "\"")
                        .replace(/&gt;/g, ">")
                        .replace(/&lt;/g, "<")
                        .replace(/&amp;/g, "&");
                }

                onChangePreview(previewed) {
                    this.setState({
                        previewed: previewed
                    });
                }

                render() {
                    return (
                        <div className="divider">
                            <TreePane data={this.state}/>
                            <PreviewPane previewed={this.previewed}/>
                        </div>
                    );
                }
            }

            function TreePane(props) {
                return (
                    <div className="divider-pane tree-pane">
                        <TreeHeader data={props.data}/>
                        <TreeError data={props.data}/>
                        <BranchList branches={props.data.tree.branches}/>
                    </div>
                );
            }

            function TreeHeader(props) {
                let elapsedText = "";
                let elapsed = props.data.tree.elapsed;
                if(elapsed && elapsed != -1) {
                    elapsedText = "(" + formatSecs(elapsed) + ")";
                }

                let anyFailed = false;
                for(let i = 0; i < props.data.tree.branches.length; i++) {
                    let branch = props.data.tree.branches[i];
                    if(branch.isFailed) {
                        anyFailed = true;
                        break;
                    }
                }

                return (
                    <div className="tree-header">
                        <div className="header">SmashTEST Report</div>
                        <div className="tree-header-container">
                            <ProgressBar decimal={props.data.tree.totalStepsComplete / props.data.tree.totalSteps}/>
                            <div className="runner-status-msg tree-header-item">
                                <div className="runner-complete">
                                    {
                                        props.data.runner.isComplete ?
                                        `Run completed ${elapsedText}` :
                                        ""
                                    }
                                    {
                                        !anyFailed && !props.data.tree.isDebug ?
                                        <span className="thumbs-up">&#x1f44d;</span> :
                                        ""
                                    }
                                </div>

                                <div className="runner-running running-item">
                                    {
                                        !props.data.isComplete && props.data.isStopped && !props.data.isPaused ?
                                        "Currently running" :
                                        ""
                                    }
                                </div>

                                <div className="runner-paused skipped-item">
                                    {
                                        props.data.isPaused ?
                                        "Run paused" :
                                        ""
                                    }
                                </div>

                                <div className="runner-stopped">
                                    {
                                        props.data.isStopped ?
                                        `Run stopped ${elapsedText}` :
                                        ""
                                    }
                                </div>

                                <div className="running-item-no-anim">
                                    {
                                        props.data.tree.isDebug ?
                                        "In DEBUG mode (~)" :
                                        ""
                                    }
                                </div>
                            </div>
                            <div className="counts tree-header-item">
                                <span className="passed-count passed-item">{props.data.tree.passed} passed</span> |
                                <span className="failed-count failed-item">{props.data.tree.failed} failed</span> |
                                <span className="skipped-count skipped-item">{props.data.tree.skipped} skipped</span> |
                                <span className="notrunyet-count notrunyet-item">{props.data.tree.totalToRun - props.data.tree.complete} not run yet</span> |
                                <span className="total-count">{props.data.tree.totalInReport} total branches</span>
                            </div>
                            <div className="msg tree-header-item">
                                This report is paused. Unselect a step/branch to resume live updates.
                            </div>
                        </div>
                    </div>
                );
            }

            class ProgressBar extends React.Component {
                constructor() {
                    super();
                    this.state = {
                        percentageText: (this.props.decimal * 100) + "%"
                    };
                }

                componentDidUpdate() {
                    if(this.filledBarText.scrollWidth > this.filledBar.offsetWidth) { // text doesn't have room
                        this.setState({
                            percentageText: ""
                        });
                    }
                }

                render() {
                    return (
                        <div className="progress-bar tree-header-item">
                            <div className="filled-bar" style={ {width: percentage}} ref={(elem) => {this.filledBar = elem} }>
                                <div className="filled-bar-text" ref={(elem) => {this.filledBarText = elem}}>
                                    {percentageText}
                                </div>
                            </div>
                        </div>
                    );
                }
            }

            function TreeErrors(props) {
                let errors =
                    props.data.tree.beforeEverything
                    .concat(props.data.tree.afterEverything)
                    .filter(hook => {
                        return hook.error;
                    })
                    .map(hook => {
                        return (
                            <div className="stacktrace">
                                {injectLineNumberIntoError(hook.error)}
                            </div>
                        );
                    });

                return (
                    <div className="tree-errors">
                        <div className="header failed-item">Hook errors</div>
                        {errors}
                    </div>
                );
            }

            function BranchList(props) {
                let branchesRunning = props.branches.filter(branch => branch.isRunning).map(branch => <Branch branch={branch}>);
                let branchesFailed = props.branches.filter(branch => branch.isFailed).map(branch => <Branch branch={branch}>);
                let branchesPassed = props.branches.filter(branch => branch.isPassed).map(branch => <Branch branch={branch}>);
                let branchesSkipped = props.branches.filter(branch => branch.isSkipped).map(branch => <Branch branch={branch}>);
                let branchesNotRunYet = props.branches.filter(branch => !branch.isRunning && !branch.isFailed && !branch.isPassed && !branch.isSkipped).map(branch => <Branch branch={branch}>);

                return (
                    <div className="branch-list">
                        <div className="header">Branches currently running</div>
                        {branchesRunning.length > 0 ? branchesRunning : <div className="none-indicator">None</div>}
                    </div>



                    <div className="branch-list">
                        <div className="header">Failed branches</div>
                        {branchesFailed.length > 0 ? branchesFailed : <div className="none-indicator">None</div>}
                    </div>



                    <div className="branch-list">
                        <div className="header">Passed branches</div>
                        {branchesPassed.length > 0 ? branchesPassed : <div className="none-indicator">None</div>}
                    </div>



                    <div className="branch-list">
                        <div className="header">Skipped branches</div>
                        {branchesSkipped.length > 0 ? branchesSkipped : <div className="none-indicator">None</div>}
                    </div>



                    <div className="branch-list">
                        <div className="header">Branches not run yet</div>
                        {branchesNotRunYet.length > 0 ? branchesNotRunYet : <div className="none-indicator">None</div>}
                    </div>
                );
            }

            function Branch(props) {
                let indicatorClassName = "branch-indicator ";
                if(props.branch.isRunning) {
                    indicatorClassName += "running";
                }
                else if(props.branch.isFailed) {
                    indicatorClassName += "failed";
                }
                else if(props.branch.isPassed) {
                    indicatorClassName += "passed";
                }
                else if(props.branch.isSkipped) {
                    indicatorClassName += "skipped";
                }
                else {
                    indicatorClassName += "notrunyet";
                }

                let error = "";
                if(props.branch.error) {
                    error = (
                        <div className="stacktrace">
                            {injectLineNumberIntoError(props.branch.error)}
                        </div>
                    );
                }

                let lines = props.branch.steps.map(step => <Line step={step}/>);

                return (
                    <div className="branch">
                        <div className={indicatorClassName}>
                        </div>
                        <div className="branch-contents">
                            {error}
                            <div className="steps">
                                {lines}
                            </div>
                        </div>
                    </div>
                );
            }

            function Line(props) {






                
                return (
                    <div className="line">
                        <span className="line-number">1</span> <!-- NOTE: Add an &nbsp; in front of the line number depending on the amount of digits in the last step of this branch -->
                        <span className="content passed-expected passed-item">
                            Passed expected
                            <span className="filelocation">[file.txt:10]</span>
                        </span>
                    </div>



                    <div className="line">
                        <span className="line-number">2</span>
                        <span className="vertical-line-container">
                            <span className="content passed-expected passed-item">
                                Passed expected
                                <span className="filelocation">[file.txt:10]</span>
                            </span>
                        </span>
                    </div>



                    <div className="line">
                        <span className="line-number">3</span>
                        <span className="vertical-line-container">
                            <span className="vertical-line-container">
                                <span className="content passed-unexpected passed-item">
                                    Passed unexpected
                                    <span className="pill unexpected">UNEXPECTED</span>
                                    <span className="filelocation">[file.txt:10]</span>
                                </span>
                            </span>
                        </span>
                    </div>



                    <div className="line">
                        <span className="line-number">4</span>
                        <span className="vertical-line-container">
                            <span className="vertical-line-container">
                                <span className="content failed-expected failed-item">
                                    Failed expected
                                    <span className="pill expected">EXPECTED</span>
                                    <span className="filelocation">[file.txt:10]</span>
                                </span>
                            </span>
                        </span>
                    </div>



                    <div className="line">
                        <span className="line-number">5</span>
                        <span className="vertical-line-container">
                            <span className="vertical-line-container">
                                <span className="content failed-unexpected failed-item">
                                    Failed unexpected
                                    <span className="pill unexpected">UNEXPECTED</span>
                                    <span className="filelocation">[file.txt:10]</span>
                                    <LineError />
                                </span>
                            </span>
                        </span>
                    </div>



                    <div className="line">
                        <span className="line-number">6</span>
                        <span className="vertical-line-container">
                            <span className="content skipped skipped-item">
                                Skipped
                                <span className="pill skipped">SKIPPED</span>
                                <span className="filelocation">[file.txt:10]</span>
                            </span>
                        </span>
                    </div>



                    <div className="line">
                        <span className="line-number">7</span>
                        <span className="vertical-line-container">
                            <span className="vertical-line-container">
                                <span className="content running running-item">
                                    Running
                                    <span className="pill running">RUNNING</span>
                                    <span className="filelocation">[file.txt:10]</span>
                                </span>
                            </span>
                        </span>
                    </div>



                    <div className="line">
                        <span className="line-number">8</span>
                        <span className="vertical-line-container">
                            <span className="vertical-line-container">
                                <span className="content notrunyet notrunyet-item">
                                    Not run yet
                                    <span className="filelocation">[file.txt:10]</span>
                                </span>
                            </span>
                        </span>
                    </div>
                );
            }

            function LineError(props) {
                return (
                    <div className="line-error">
                        <div className="stacktrace">
                            Error: Before/After Every Step error, or Step error [file.txt:12] (from error.filename/error.lineNumber)<br>
                            &nbsp;&nbsp;If Step.error exists (regardless of expectation), this section will be rendered<br>
                            &nbsp;&nbsp;STACK TRACE HERE<br>
                            &nbsp;&nbsp;STACK TRACE HERE<br>
                            &nbsp;&nbsp;STACK TRACE HERE<br>
                            &nbsp;&nbsp;STACK TRACE HERE
                        </div>
                    </div>
                );
            }

            function PreviewPane(props) {
                return (
                    <NoPreview />



                    <StepPreview />




                    <BranchPreview />
                );
            }

            function NoPreview(props) {
                return (
                    <div className="divider-pane preview-pane">
                        <div className="preview-pane-msg">
                            < Select a step to preview
                        </div>
                    </div>
                );
            }

            function StepPreview(props) {
                return (
                    <div className="divider-pane preview-pane step-preview">
                        <div className="header preview-name failed-item">
                            My big failing step
                            <span className="filelocation">[file.txt:10]</span>
                            <span className="filelocation">(13 m 45 s)</span>
                        </div>



                        <div className="preview-state passed-item">
                            Passed
                        </div>



                        <div className="preview-state passed-item">
                            Passed unexpectedly
                        </div>



                        <div className="preview-state failed-item">
                            Failed
                        </div>



                        <div className="preview-state failed-item">
                            Failed expectedly
                        </div>



                        <div className="preview-state running-item-no-anim">
                            Currently running
                        </div>



                        <div className="preview-state skipped-item">
                            Skipped
                        </div>



                        <div className="preview-state notrunyet-item">
                            Not run yet
                        </div>

                        <PreviewError />
                        <PreviewDetails />
                        <PreviewLogs />
                    </div>
                );
            }

            function BranchPreview(props) {
                return (
                    <div className="divider-pane preview-pane branch-preview">
                        // NOTE: If timeElapsed is -1 or undefined, don't print it out
                        // NOTE: filename:lineNumber of last step in this branch, whether or not that step passed or even ran

                        <div className="header preview-name failed-item">
                            Branch ending at file.txt:10
                            <span className="filelocation">(13 m 45 s)</span>
                        </div>



                        <div className="preview-state passed-item">
                            Passed
                        </div>



                        <div className="preview-state failed-item">
                            Failed
                        </div>



                        <div className="preview-state running-item-no-anim">
                            Currently running
                        </div>



                        <div className="preview-state skipped-item">
                            Skipped
                        </div>



                        <div className="preview-state notrunyet-item">
                            Not run yet
                        </div>


                        <PreviewError />
                        <PreviewLogs />
                    </div>
                );
            }

            function PreviewError(props) {
                return (
                    <div className="preview-error">
                        <div className="header">Error</div>
                        <div className="stacktrace">
                            Error: Before/After Every Step error, or Step error [file.txt:12] (from error.filename/error.lineNumber)<br>
                            &nbsp;&nbsp;If Step.error exists (regardless of expectation), this section will be rendered<br>
                            &nbsp;&nbsp;STACK TRACE HERE<br>
                            &nbsp;&nbsp;STACK TRACE HERE<br>
                            &nbsp;&nbsp;STACK TRACE HERE<br>
                            &nbsp;&nbsp;STACK TRACE HERE
                        </div>




                        <div className="stacktrace">
                            Error: Before/After Every Branch error [file.txt:12] (from error.filename/error.lineNumber)<br>
                            &nbsp;&nbsp;If Branch.error exists, this section will be rendered<br>
                            &nbsp;&nbsp;STACK TRACE HERE<br>
                            &nbsp;&nbsp;STACK TRACE HERE<br>
                            &nbsp;&nbsp;STACK TRACE HERE<br>
                            &nbsp;&nbsp;STACK TRACE HERE
                        </div>
                    </div>
                );
            }

            function PreviewDetails(props) {
                return (
                    <div className="preview-details">
                        <div className="header">Details</div>
                        <div className="step-report">
                        </div>
                    </div>
                );
            }

            function PreviewLogs(props) {
                return (
                    <div className="header">Logs</div>
                    <div className="logs">
                        <div className="log-line">LOG LINE</div>
                        <div className="log-line">LOG LINE</div>
                        <div className="log-line">LOG LINE</div>
                        <div className="log-line">LOG LINE</div>
                        <div className="log-line">LOG LINE</div>
                        <div className="log-line">LOG LINE</div>
                    </div>
                );
            }

            ReactDOM.render(
                <App message="meow"/>,
                document.querySelector("#root")
            );

            /**
             * Converts a number of seconds to Xh Xm Xs format
             */
            function formatSecs(secs) {
                let hours = Math.floor(secs/3600);
                secs %= 3600;
                let mins = Math.floor(secs/60);
                secs %= 60;

                return
                    (hours > 0 ? hours + "h " : "") +
                    (hours > 0 || mins > 0 ? mins + "m " : "") +
                    (secs + "s");
            }

            /**
             * Injects [filename:lineNumber] into the given Error's stack trace, and returns it
             */
            function injectLineNumberIntoError(error) {
                return error.stack.replace(/\n/, `[${error.filename}:${error.lineNumber}]\n`);
            }









            // Tooltips
            let tippyOptions = {
                placement: "right",
                followCursor: true,
                delay: 0,
                animation: "fade",
                arrow: true,
                arrowType: "sharp"
            };

            function wrapTippyContent(content) {
                return "<span class='tooltip-text'>" + content + "</span>";
            }

            tippyOptions.content = wrapTippyContent("Currently running branch");
            tippy(".branch-indicator.running", tippyOptions);

            tippyOptions.content = wrapTippyContent("Branch passed");
            tippy(".branch-indicator.passed", tippyOptions);

            tippyOptions.content = wrapTippyContent("Branch failed");
            tippy(".branch-indicator.failed", tippyOptions);

            tippyOptions.content = wrapTippyContent("Branch skipped");
            tippy(".branch-indicator.skipped", tippyOptions);

            tippyOptions.content = wrapTippyContent("Branch not run yet");
            tippy(".branch-indicator.notrunyet", tippyOptions);

            tippyOptions.content = wrapTippyContent("This step passed, but was<br>expected to fail (#)");
            tippy(".pill.unexpected", tippyOptions);

            tippyOptions.content = wrapTippyContent("This step failed,<br>as was expected (#)");
            tippy(".pill.expected", tippyOptions);

            tippyOptions.content = wrapTippyContent("Congrats! All branches passed");
            tippy(".thumbs-up", tippyOptions);

            // Branch's indicator events
            document.querySelectorAll(".branch-indicator").forEach((elem) => {
                let branch = elem.closest(".branch");

                elem.addEventListener("mouseover", () => {
                    branch.classList.add("hover");
                });

                elem.addEventListener("mouseout", () => {
                    branch.classList.remove("hover");
                });

                elem.addEventListener("click", () => {
                    toggleActive(branch);
                    clearSelections(branch);
                });
            });

            // Line events
            document.querySelectorAll(".line").forEach((elem) => {
                elem.addEventListener("click", () => {
                    toggleActive(elem);
                    clearSelections(elem);
                });
            });

            function clearSelections(notElem) {
                document.querySelectorAll(".branch").forEach(elem => elem !== notElem && elem.classList.remove("active"));
                document.querySelectorAll(".line").forEach(elem => elem !== notElem && elem.classList.remove("active"));
            }

            function toggleActive(elem) {
                if(elem.classList.contains("active")) {
                    elem.classList.remove("active");
                }
                else {
                    elem.classList.add("active");
                }
            }
        </script>
    </body>
</html>
