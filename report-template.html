<html>
    <head>
        <meta name="treeObj" content="{{{treeObj}}}"/>
        <meta name="runnerObj" content="{{{runnerObj}}}"/>
        <meta name="reportTime" content="{{{reportTime}}}"/>

        <title>SmashTEST Report</title>

        <script src="https://unpkg.com/popper.js@1"></script>
        <script src="https://unpkg.com/tippy.js@4"></script>

        <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
        <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

        <style>
            body {
                background-color: black;
                color: white;
                font-family: Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
                margin: 0;
                padding: 0;
                overflow-y: hidden;
            }

            .header {
                font-size: 16px;
                margin: 0 0 20px 6px;
            }

            .pane {
                position: absolute;
                top: 0;
                bottom: 0;
                width: calc(50% - 15px);
                height: 100%;
                vertical-align: top;
                border: 0;
                margin: 0;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .tree-pane {
                left: 0;
                padding: 10px 0 10px 8px;
            }

            .preview-pane {
                right: 0;
                padding: 10px 14px;
                background-color: rgb(40,40,40);
            }

            .tree-header {
                margin: 0 0 20px 0;
            }

            .tree-header-container {
                margin: 0 0 0 10px;
                font-size: 13px;
            }

            .runner-complete {
                color: #ffb347;
            }

            .branch-list {
                margin: 0 0 30px 0;
            }

            .branch {
                margin-bottom: 30px;
                margin-left: 8px;
                position: relative;
            }

            .branch.active {
                background-color: rgb(40,40,40);
            }

            .branch.hover {
                background-color: rgb(40,40,40);
                /*background-color: rgb(70,70,70);*/
            }

            .branch-indicator {
                display: inline-block;
                position: absolute;
                top: 0;
                left: 0;
                width: 10px;
                height: 100%;
                min-width: 10px;
                border: 0;
                margin: 0;
                padding: 0;
                border-radius: 3px;
                z-index: 3;
            }

            .branch-indicator:hover {
                cursor: pointer;
            }

            .branch-indicator.notrunyet {
                background-color: gray;
            }

            .branch-indicator.running {
                background-color: orange;
                animation: blinker 2s linear infinite;
            }

            @keyframes blinker {
                50% {
                    opacity: 0.3;
                }
            }

            .branch-indicator.passed {
                background-color: green;
            }

            .branch-indicator.failed {
                background-color: red;
            }

            .branch-indicator.skipped {
                background-color: rgb(0,200,200);
            }

            .branch-contents {
                display: inline-block;
                width: 100%;
                border: 0;
                margin: 0;
                padding-left: 10px;
                padding-right: 0;
            }

            .line {
                font-size: 14px;
                position: relative;
                white-space: nowrap;
                cursor: pointer;
                overflow-x: auto;
                padding-right: 20px;
                /*padding: 1px 20px 1px 0;*/
            }

            .line::-webkit-scrollbar {
                display: none;
            }

            .line.active {
                background-color: rgb(40,40,40);
            }

            .line:hover {
                background-color: rgb(40,40,40);
                /*background-color: rgb(70,70,70);*/
            }

            .line .content {
                display: inline-block;
            }

            .line .location {
                visibility: hidden;
                display: inline-block;
                vertical-align: top;
                color: rgb(90,90,90);
                padding: 0 30px;
                font-size: 13px;
            }

            .line:hover .location {
                visibility: visible;
            }

            .pill {
                position: relative;
                top: -2px;
                color: white;
                padding: 1px 3px;
                border-radius: 5px;
                font-size: 11px;
                margin: 0 10px;
            }

            .pill.expected {
                background-color: green;
            }

            .pill.unexpected {
                background-color: red;
            }

            .pill.skipped {
                background-color: rgb(0,200,200);
            }

            .pill.running {
                background-color: orange;
            }

            .tooltip-text {
                font-size: 12px;
            }

            .progress-bar {
                height: 20px;
                margin-right: 10px;
                padding: 0;
            }

            .progress-bar .filled-bar {
                background-color: rgb(245,155,0);
                color: white;
                text-align: center;
                height: 100%;
                overflow-x: hidden;
            }

            .progress-bar .filled-bar-text {
                position: relative;
                top: 2px;
                padding: 0 5px;
            }

            .msg {
                color: rgb(100,100,100);
                font-size: 12px;
                font-weight: normal;
            }

            .refresh-msg {
                white-space: nowrap;
            }

            .refresh-msg:hover {
                cursor: pointer;
                filter: brightness(1.75);
            }

            .refresh-icon {
                width: 14px;
                vertical-align: bottom;
            }

            .tree-header-item {
                margin-bottom: 5px;
            }

            .notrunyet-item {
                color: gray;
            }

            .running-item {
                color: orange;
                animation: blinker 2s linear infinite;
            }

            .running-item-no-anim {
                color: orange;
            }

            .passed-item {
                color: rgb(0,200,0);
            }

            .failed-item {
                color: red;
            }

            .skipped-item {
                color: rgb(0,200,200);
            }

            .counts {
                line-height: 16px;
            }

            .line-index {
                color: rgb(100,100,100);
                font-size: 11px;
                display: inline-block;
                vertical-align: top;
                position: relative;
                top: 2px;
                margin: 0 8px;
            }

            .vertical-line-container {
                border-left: 1px dashed rgb(100,100,100);
                margin-left: 4px;
                padding-left: 8px;
                display: inline-block;
            }

            .line > .vertical-line-container {
                position: relative;
                top: 1px;
                margin-bottom: 1px;
            }

            .stacktrace {
                padding: 10px 0 25px 30px;
                color: white;
                font-size: 12px;
                white-space: pre;
            }

            .preview-pane .stacktrace {
                padding: 0 30px 15px;
                overflow-x: auto;
            }

            /*.preview-pane .stacktrace::-webkit-scrollbar {
                display: none;
            }*/

            .logs {
                padding: 5px 0 20px 30px;
                color: white;
                font-size: 12px;
            }

            .thumbs-up {
                cursor: default;
            }

            .preview-pane .preview-name {
                margin-bottom: 10px;
            }

            .preview-pane .preview-name .location {
                color: rgb(130,130,130);
                font-size: 12px;
                margin-left: 20px;
                position: relative;
                top: -1px;
            }

            .preview-pane .preview-name .elapsed {
                color: rgb(130,130,130);
                font-size: 12px;
            }

            .preview-pane .preview-state {
                margin-left: 20px;
                font-size: 13px;
            }

            .preview-pane .msg {
                margin-top: 10px;
                margin-bottom: 30px;
                margin-left: 20px;
                font-size: 13px;
            }

            .preview-pane .preview-state .pill {
                position: relative;
                top: -1px;
                cursor: pointer;
            }

            .step-report {
                margin: 20px;
            }

            .preview-pane-msg {
                color: rgb(90,90,90);
                font-size: 16px;
                padding-top: 70px;
                text-align: center;
            }

            .preview-section {
                margin: 0 0 30px 0;
            }

            .none-indicator {
                color: rgb(90,90,90);
                font-size: 13px;
                margin-left: 20px;
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <script type="text/babel">
            // Tooltips

            let tippyOptions = {
                placement: "right",
                followCursor: true,
                delay: 0,
                animation: "fade",
                arrow: true,
                arrowType: "sharp"
            };

            function wrapTippyContent(content) {
                return "<span class='tooltip-text'>" + content + "</span>";
            }

            function attachPreviewPaneTooltips() {
                tippyOptions.content = wrapTippyContent("This step passed, but was<br>expected to fail (#)");
                tippy(".preview-pane .pill.unexpected", tippyOptions);

                tippyOptions.content = wrapTippyContent("This step failed,<br>as was expected (#)");
                tippy(".preview-pane .pill.expected", tippyOptions);
            }

            function attachTreePaneTooltips() {
                tippyOptions.content = wrapTippyContent("Currently running branch");
                tippy(".branch-indicator.running", tippyOptions);

                tippyOptions.content = wrapTippyContent("Branch passed");
                tippy(".branch-indicator.passed", tippyOptions);

                tippyOptions.content = wrapTippyContent("Branch failed");
                tippy(".branch-indicator.failed", tippyOptions);

                tippyOptions.content = wrapTippyContent("Branch skipped");
                tippy(".branch-indicator.skipped", tippyOptions);

                tippyOptions.content = wrapTippyContent("Branch not run yet");
                tippy(".branch-indicator.notrunyet", tippyOptions);

                tippyOptions.content = wrapTippyContent("This step passed, but was<br>expected to fail (#)");
                tippy(".pill.unexpected", tippyOptions);

                tippyOptions.content = wrapTippyContent("This step failed,<br>as was expected (#)");
                tippy(".pill.expected", tippyOptions);

                /*tippyOptions.content = wrapTippyContent("Congrats! All branches passed");
                tippy(".thumbs-up", tippyOptions);*/
            }

            // React Components

            class App extends React.Component {
                constructor() {
                    super();

                    this.state = {
                        tree: null,
                        runner: null,
                        reportTime: null,
                        previewedItem: null
                    };

                    // Parse in tree
                    let treeContent = document.querySelector("meta[name=treeObj]").getAttribute("content");
                    let treeJSON = this.unescapeHtml(treeContent);
                    if(!treeJSON.startsWith("\{\{\{")) {
                        this.state.tree = JSON.parse(treeJSON);
                    }

                    // Parse in runner
                    let runnerContent = document.querySelector("meta[name=runnerObj]").getAttribute("content");
                    let runnerJSON = this.unescapeHtml(runnerContent);
                    if(!runnerJSON.startsWith("\{\{\{")) {
                        this.state.runner = JSON.parse(runnerJSON);
                    }

                    // Parse in reportTime
                    this.state.reportTime = document.querySelector("meta[name=reportTime]").getAttribute("content");

                    this.setPreview = this.setPreview.bind(this);
                }

                unescapeHtml(str) {
                    return str
                        .replace(/&#039;/g, "'")
                        .replace(/&quot;/g, "\"")
                        .replace(/&gt;/g, ">")
                        .replace(/&lt;/g, "<")
                        .replace(/&amp;/g, "&");
                }

                setPreview(previewedItem) {
                    this.setState(state => {
                        if(state.previewedItem === previewedItem) { // toggle off
                            return {
                                previewedItem: null
                            };
                        }
                        else { // toggle on
                            return {
                                previewedItem: previewedItem
                            };
                        }
                    });
                }

                render() {
                    return (
                        <div className="main">
                            <TreePane data={this.state} setPreview={this.setPreview}/>
                            <PreviewPane previewedItem={this.state.previewedItem}/>
                        </div>
                    );
                }
            }

            function TreePane(props) {
                if(!props.data.tree) {
                    return "";
                }

                return (
                    <div className="pane tree-pane">
                        <TreeHeader data={props.data}/>
                        <TreeErrors data={props.data}/>
                        <BranchListing branches={props.data.tree.branches} setPreview={props.setPreview} previewedItem={props.data.previewedItem}/>
                    </div>
                );
            }

            function TreeHeader(props) {
                let elapsedText = "";
                let elapsed = props.data.tree.elapsed;
                if(typeof elapsed != undefined && elapsed != -1) {
                    elapsedText = "(" + formatElapsed(elapsed) + ")";
                }

                let anyFailed = false;
                for(let i = 0; i < props.data.tree.branches.length; i++) {
                    let branch = props.data.tree.branches[i];
                    if(branch.isFailed) {
                        anyFailed = true;
                        break;
                    }
                }

                return (
                    <div className="tree-header">
                        <div className="header">SmashTEST Report</div>
                        <div className="tree-header-container">
                            {
                                !props.data.runner.isComplete && !props.data.runner.isStopped ?
                                <ProgressBar decimal={props.data.tree.totalStepsComplete / props.data.tree.totalSteps}/> :
                                ""
                            }
                            <div className="runner-status-msg tree-header-item">
                                <div className="runner-complete">
                                    {
                                        props.data.runner.isComplete ?
                                        `Run completed ${elapsedText}` :
                                        ""
                                    }
                                    {/*
                                        !anyFailed && !props.data.tree.isDebug ?
                                        <span className="thumbs-up"> &#x2714;</span> :
                                        ""
                                    */}
                                </div>

                                <div className="runner-running running-item">
                                    {
                                        !props.data.isComplete && props.data.isStopped && !props.data.isPaused ?
                                        "Currently running" :
                                        ""
                                    }
                                </div>

                                <div className="runner-paused skipped-item">
                                    {
                                        props.data.isPaused ?
                                        "Run paused" :
                                        ""
                                    }
                                </div>

                                <div className="runner-stopped">
                                    {
                                        props.data.isStopped ?
                                        `Run stopped ${elapsedText}` :
                                        ""
                                    }
                                </div>

                                <div className="running-item-no-anim">
                                    {
                                        props.data.tree.isDebug ?
                                        "In DEBUG mode (~)" :
                                        ""
                                    }
                                </div>
                            </div>
                            <div className="counts tree-header-item">
                                <span className="passed-count passed-item"> {props.data.tree.passed} passed</span> |
                                <span className="failed-count failed-item"> {props.data.tree.failed} failed</span> |
                                <span className="skipped-count skipped-item"> {props.data.tree.skipped} skipped</span> |
                                <span className="notrunyet-count notrunyet-item"> {props.data.tree.totalToRun - props.data.tree.complete} not run yet</span> |
                                <span className="total-count notrunyet-item"> {props.data.tree.totalInReport} total branches</span>
                            </div>
                        </div>
                    </div>
                );
            }

            class ProgressBar extends React.Component {
                constructor() {
                    super();
                    this.state = {
                        showPercentage: true
                    };
                }

                componentDidUpdate() {
                    if(this.filledBarText.scrollWidth > this.filledBar.offsetWidth) { // text doesn't have room
                        this.setState({
                            showPercentage: false
                        });
                    }
                }

                render() {
                    let percentageText = (this.props.decimal * 100) + "%";
                    return (
                        <div className="progress-bar tree-header-item">
                            <div className="filled-bar" style={ {width: percentageText} } ref={(elem) => {this.filledBar = elem} }>
                                <div className="filled-bar-text" ref={(elem) => {this.filledBarText = elem}}>
                                    {this.state.showPercentage ? percentageText : ""}
                                </div>
                            </div>
                        </div>
                    );
                }
            }

            function TreeErrors(props) {
                let errors =
                    props.data.tree.beforeEverything
                    .concat(props.data.tree.afterEverything)
                    .filter(hook => {
                        return hook.error;
                    })
                    .map(hook => {
                        return (
                            <div className="stacktrace">
                                {formatStackTrace(hook.error)}
                            </div>
                        );
                    });

                if(errors.length > 0) {
                    return (
                        <div className="tree-errors">
                            <div className="header failed-item">Hook errors</div>
                            {errors}
                        </div>
                    );
                }
                else {
                    return "";
                }
            }

            function BranchListing(props) {
                let branchesRunning = props.branches
                    .filter(branch => branch.isRunning)
                    .map((branch, index) => <Branch key={index} branch={branch} setPreview={props.setPreview} previewedItem={props.previewedItem}/>);
                let branchesFailed = props.branches
                    .filter(branch => branch.isFailed)
                    .map((branch, index) => <Branch key={index} branch={branch} setPreview={props.setPreview} previewedItem={props.previewedItem}/>);
                let branchesPassed = props.branches
                    .filter(branch => branch.isPassed)
                    .map((branch, index) => <Branch key={index} branch={branch} setPreview={props.setPreview} previewedItem={props.previewedItem}/>);
                let branchesSkipped = props.branches
                    .filter(branch => branch.isSkipped)
                    .map((branch, index) => <Branch key={index} branch={branch} setPreview={props.setPreview} previewedItem={props.previewedItem}/>);
                let branchesNotRunYet = props.branches
                    .filter(branch => !branch.isRunning && !branch.isFailed && !branch.isPassed && !branch.isSkipped)
                    .map((branch, index) => <Branch key={index} branch={branch} setPreview={props.setPreview} previewedItem={props.previewedItem}/>);

                return (
                    <div className="branch-listing">
                        {
                            branchesRunning.length > 0 ? (
                                <div className="branch-list">
                                    <div className="header">Branches currently running</div>
                                    {branchesRunning}
                                </div>
                            ) : ""
                        }

                        {
                            branchesFailed.length > 0 ? (
                                <div className="branch-list">
                                    <div className="header">Failed branches</div>
                                    {branchesFailed}
                                </div>
                            ) : ""
                        }

                        {
                            branchesPassed.length > 0 ? (
                                <div className="branch-list">
                                    <div className="header">Passed branches</div>
                                    {branchesPassed}
                                </div>
                            ) : ""
                        }

                        {
                            branchesSkipped.length > 0 ? (
                                <div className="branch-list">
                                    <div className="header">Skipped branches</div>
                                    {branchesSkipped}
                                </div>
                            ) : ""
                        }

                        {
                            branchesNotRunYet.length > 0 ? (
                                <div className="branch-list">
                                    <div className="header">Branches not run yet</div>
                                    {branchesNotRunYet}
                                </div>
                            ) : ""
                        }
                    </div>
                );
            }

            class Branch extends React.Component {
                constructor() {
                    super();
                    this.state = {
                        hovered: false
                    };

                    this.hoverStateOn = this.hoverStateOn.bind(this);
                    this.hoverStateOff = this.hoverStateOff.bind(this);
                    this.toggleActiveState = this.toggleActiveState.bind(this);
                }

                hoverStateOn() {
                    this.setState({
                        hovered: true
                    });
                }

                hoverStateOff() {
                    this.setState({
                        hovered: false
                    });
                }

                toggleActiveState() {
                    this.props.setPreview(this);
                }

                render() {
                    let indicatorClassName = "branch-indicator ";

                    if(this.props.branch.isRunning) {
                        indicatorClassName += "running";
                    }
                    else if(this.props.branch.isFailed) {
                        indicatorClassName += "failed";
                    }
                    else if(this.props.branch.isPassed) {
                        indicatorClassName += "passed";
                    }
                    else if(this.props.branch.isSkipped) {
                        indicatorClassName += "skipped";
                    }
                    else {
                        indicatorClassName += "notrunyet";
                    }

                    let error = "";
                    if(this.props.branch.error) {
                        error = (
                            <div className="stacktrace">
                                {formatStackTrace(this.props.branch.error)}
                            </div>
                        );
                    }

                    let lines = this.props.branch.steps.map((step, index) =>
                            <Line
                                step={step}
                                index={index+1}
                                key={index}
                                lastIndex={this.props.branch.steps.length - 1}
                                setPreview={this.props.setPreview}
                                previewedItem={this.props.previewedItem}
                            />);

                    let branchClassName = "branch ";
                    if(this.state.hovered) {
                        branchClassName += "hover ";
                    }
                    if(this.props.previewedItem === this) {
                        branchClassName += "active ";
                    }

                    return (
                        <div className={branchClassName}>
                            <div
                                className={indicatorClassName}
                                onMouseOver={this.hoverStateOn}
                                onMouseOut={this.hoverStateOff}
                                onClick={this.toggleActiveState}
                            >
                            </div>
                            <div className="branch-contents">
                                {error}
                                <div className="steps">
                                    {lines}
                                </div>
                            </div>
                        </div>
                    );
                }
            }

            class Line extends React.Component {
                constructor() {
                    super();
                    this.toggleActiveState = this.toggleActiveState.bind(this);
                }

                surroundByVerticalLineContainers(elem, n) {
                    for(let i = 0; i < n; i++) {
                        elem = this.surroundByVerticalLineContainer(elem);
                    }

                    return elem;
                }

                surroundByVerticalLineContainer(elem) {
                    return (
                        <span className="vertical-line-container">
                            {elem}
                        </span>
                    );
                }

                toggleActiveState() {
                    this.props.setPreview(this);
                }

                render() {
                    // Add an &nbsp; in front of the line number depending on the amount of digits in the last step of this branch (so they're all the same length)
                    let index = this.props.index;
                    let indexDigits = index.toString().length;
                    let maxDigits = this.props.lastIndex.toString().length;

                    function getIndexElem(index) {
                        return <span className="line-index">{indexElemSpaces(indexDigits)}{index}</span>;
                    }

                    function indexElemSpaces(i) {
                        if(i < maxDigits) {
                            return <span>&nbsp;{indexElemSpaces(i+1)}</span>;
                        }
                    }

                    let className = "content ";
                    let pill = "";
                    if(this.props.step.isRunning) {
                        className += "running running-item";
                        pill = <span className="pill running">RUNNING</span>;
                    }
                    else if(this.props.step.isPassed) {
                        if(this.props.step.asExpected) {
                            className += "passed-expected passed-item";
                        }
                        else {
                            className += "passed-unexpected passed-item";
                            pill = <span className="pill unexpected">UNEXPECTED</span>;
                        }
                    }
                    else if(this.props.step.isFailed) {
                        if(this.props.step.asExpected) {
                            className += "failed-expected failed-item";
                            pill = <span className="pill expected">EXPECTED</span>;
                        }
                        else {
                            className += "failed-unexpected failed-item";
                        }
                    }
                    else if(this.props.step.isSkipped) {
                        className += "skipped skipped-item";
                        pill = <span className="pill skipped">SKIPPED</span>;
                    }
                    else { // not run yet
                        className += "notrunyet notrunyet-item";
                    }

                    let error = "";
                    if(this.props.step.error) {
                        error = (
                            <div className="stacktrace">
                                {formatStackTrace(this.props.step.error)}
                            </div>
                        );
                    }

                    let lineElem = (
                        <span className={className}>
                            {this.props.step.line.trim()}
                            {pill}
                            <span className="location">[{this.props.step.filename}:{this.props.step.lineNumber}]</span>
                            {error}
                        </span>
                    );
                    lineElem = this.surroundByVerticalLineContainers(lineElem, this.props.step.branchIndents);

                    let lineClassName = "line ";
                    if(this.props.previewedItem === this) {
                        lineClassName += "active ";
                    }

                    return (
                        <div className={lineClassName} onClick={this.toggleActiveState}>
                            {getIndexElem(index)}
                            {lineElem}
                        </div>
                    );
                }
            }

            class PreviewPane extends React.Component {
                constructor() {
                    super();
                }

                componentDidUpdate() {
                    attachPreviewPaneTooltips();
                }

                render() {
                    if(this.props.previewedItem) {
                        return (
                            <Preview previewedItem={this.props.previewedItem}/>
                        );
                    }
                    else {
                        return (
                            <NoPreview />
                        );
                    }
                }
            }

            function NoPreview(props) {
                return (
                    <div className="pane preview-pane">
                        <div className="preview-pane-msg">
                            &lt; Select a step to preview
                        </div>
                    </div>
                );
            }

            function Preview(props) {
                let previewedItem = props.previewedItem.props.step || props.previewedItem.props.branch;
                let isBranch = previewedItem.hasOwnProperty("steps");

                let headerClassName = "header preview-name ";
                let previewStateClassName = "preview-state ";
                let previewStateText = "";
                let pill = "";
                if(previewedItem.isRunning) {
                    headerClassName += "running-item-no-anim";
                    previewStateClassName += "running-item";
                    previewStateText = "Currently running";
                }
                else if(previewedItem.isPassed) {
                    const className = "passed-item";
                    headerClassName += className;
                    previewStateClassName += className;

                    previewStateText = "Passed";

                    if(previewedItem.asExpected === false) {
                        pill = <span className="pill unexpected">UNEXPECTED</span>;
                    }
                }
                else if(previewedItem.isFailed) {
                    const className = "failed-item";
                    headerClassName += className;
                    previewStateClassName += className;

                    previewStateText = "Failed";

                    if(previewedItem.error && previewedItem.error.continue) {
                        previewStateText += ", but continued branch";
                    }

                    if(previewedItem.asExpected === true) {
                        pill = <span className="pill expected">EXPECTED</span>;
                    }
                }
                else if(previewedItem.isSkipped) {
                    const className = "skipped-item";
                    headerClassName += className;
                    previewStateClassName += className;
                    previewStateText = "Skipped";
                }
                else { // Not run yet
                    const className = "notrunyet-item";
                    headerClassName += className;
                    previewStateClassName += className;
                    previewStateText = "Not run yet";
                }

                let elapsedText = "";
                let elapsed = previewedItem.elapsed;
                if(typeof elapsed != "undefined" && elapsed != -1) {
                    elapsedText = "(" + formatElapsed(elapsed) + ")";
                }

                let className = "pane preview-pane " + (isBranch ? "branch-preview" : "step-preview");

                let previewedItemText = "";
                if(isBranch) {
                    previewedItemText = `Branch ending at ${previewedItem.steps[previewedItem.steps.length - 1].filename}:${previewedItem.steps[previewedItem.steps.length - 1].lineNumber}`;
                }
                else {
                    previewedItemText = previewedItem.line.trim();
                }

                let postPreviewedItemText = "";
                if(isBranch) {
                    postPreviewedItemText = `${elapsedText}`;
                }
                else {
                    postPreviewedItemText = `[${previewedItem.filename}:${previewedItem.lineNumber}] ${elapsedText}`;
                }

                return (
                    <div className={className}>
                        <div className={headerClassName}>
                            {previewedItemText}
                            <span className="location">{postPreviewedItemText}</span>
                        </div>

                        <div className={previewStateClassName}>
                            {previewStateText}
                            {pill}
                        </div>

                        <div className="msg">
                            This report is paused. Unselect this {isBranch ? "branch" : "step"} to resume live updates.
                        </div>

                        <PreviewError previewedItem={previewedItem}/>
                        {isBranch ? "" : <PreviewDetails previewedItem={previewedItem}/>}
                        <PreviewLogs previewedItem={previewedItem}/>
                    </div>
                );
            }

            function PreviewError(props) {
                if(props.previewedItem.error) {
                    return (
                        <div className="preview-section preview-error">
                            <div className="header">Error</div>
                            <div className="stacktrace">
                                {formatStackTrace(props.previewedItem.error)}
                            </div>
                        </div>
                    );
                }
                else {
                    return "";
                }
            }

            function PreviewDetails(props) {
                return (
                    <div className="preview-section preview-details">
                        <div className="header">Details</div>
                        {
                            props.previewedItem.htmlReport ?
                            <div className="step-report">
                                {props.previewedItem.htmlReport}
                            </div> :
                            <div className="none-indicator">
                                None
                            </div>
                        }
                    </div>
                );
            }

            function PreviewLogs(props) {
                let logs = props.previewedItem.log;
                if(logs) {
                    logs = logs.map((logItem, index) => <div className="log-line" key={index}>{logItem.text}</div>);
                }

                return (
                    <div className="preview-section preview-logs">
                        <div className="header">Logs</div>
                        {
                            logs ?
                            <div className="logs">
                                {logs}
                            </div> :
                            <div className="none-indicator">
                                None
                            </div>
                        }
                    </div>
                );
            }

            ReactDOM.render(
                <App />,
                document.getElementById("root")
            );

            /**
             * Converts a number of ms to Xh Xm Xs Xms format
             */
            function formatElapsed(ms) {
                let hours = Math.floor(ms/3600000);
                ms %= 3600000;
                let mins = Math.floor(ms/60000);
                ms %= 60000;
                let secs = Math.floor(ms/1000);
                ms %= 1000;

                return (hours > 0 ? hours + "h " : "") +
                    (hours > 0 || mins > 0 ? mins + "m " : "") +
                    (hours > 0 || mins > 0 || secs > 0 ? secs + "s " : "") +
                    (hours == 0 && mins == 0 && secs == 0 ? ms + "ms" : "");
            }

            /**
             * Injects [filename:lineNumber] into the given Error's stack trace, and returns it
             */
            function formatStackTrace(error) {
                return error.stackTrace.replace(/\n/, `   [${error.filename}:${error.lineNumber}]\n`);
            }

            attachTreePaneTooltips();
        </script>
    </body>
</html>
