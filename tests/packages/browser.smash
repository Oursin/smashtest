* Open a browser [

    Open Chrome $
    Open Firefox $
    Open Safari
    Open IE
    Open Edge
    Open browser 'chrome'

        Initialize browser +? {
            g('setPageBody',
                async function(htmlStr) {
                    await browser.executeScript(function(htmlStr) {
                        document.body.innerHTML = htmlStr;
                    }, htmlStr);
                }
            );

            g(`test page location`, `file:///${dir()}/generic-page.html`);
        }
]

Open a browser

    Navigate to {test page location}

        - Category: Actions

            - Navigate

                Navigate to {url:}
                Nav to {url:}

                    {url} is 'http://www.example.com'
                        Verify at 'http://www.example.com/'

                    {url} is 'https://www.example.com'
                        Verify at 'https://www.example.com/'

                    {url} is 'https://www.example.com/something'
                        Verify at 'https://www.example.com/something'

                    {url} is 'www.example.com'
                        Verify at 'http://www.example.com/'

                Navigate to 'http://www.example.com'
                    Navigate to '/something'
                        Verify at 'http://www.example.com/something'

                Navigate to '/page'
                    - Debug and manually verify above step fails #manual $s

                * Verify at {{url}} {
                    let currUrl = await browser.driver.getCurrentUrl();
                    if(currUrl != url) {
                        throw new Error(`Expected url: '${url}', Actual url: '${currUrl}'`);
                    }
                }

            - Click

                - a button

                    Generate page {
                        await setPageBody(`
                            <button id="target" onclick="document.getElementById('display').innerHTML = 'I was clicked'">click me</button>
                            <div id="display"></div>
                        `);

                        props({
                            'target button': `#target`
                        });
                    }

                        Click [target button]

                            Verify ['I was clicked'] is visible

                - an unclickable child of a clickable parent

                    Generate page {
                        await setPageBody(`
                            <button id="target" onclick="document.getElementById('display').innerHTML = 'I was clicked'">
                                <div id="target-child">click me</div>
                            </button>
                            <div id="display"></div>
                        `);
                    }

                        where a 'text' EF is used and automatically targets the parent {
                            props({
                                'target button': `'click me'`
                            });
                        }

                            Click [target button]

                                Verify the parent gets clicked

                        where an EF directly targets the child, and the click event has to reach the parent {
                            props({
                                'target button': `#target-child`
                            });
                        }

                            Click [target button]

                                Verify the parent gets clicked

                        * Verify the parent gets clicked
                            Verify ['I was clicked'] is visible

            - Native click

                Generate page {
                    await setPageBody(`
                        <button id="target" onclick="document.getElementById('display').innerHTML = 'I was clicked'">click me</button>
                        <div id="display"></div>
                    `);

                    props({
                        'target button': `#target`
                    });
                }

                    Native click [target button]

                        Verify ['I was clicked'] is visible

            - Double click

                Generate page {
                    await setPageBody(`
                        <button id="target" ondblclick="document.getElementById('display').innerHTML = 'I was double-clicked'">click me</button>
                        <div id="display"></div>
                    `);

                    props({
                        'target button': `#target`
                    });
                }

                    Double click [target button]

                        Verify ['I was double-clicked'] is visible

            - Hover over
                [
                    - an element visible in the current viewport

                        Generate page {
                            await setPageBody(`
                                <button id="target" onmouseover="document.getElementById('display').innerHTML = 'I was hovered over'">hover over me</button>
                                <div id="display"></div>
                            `);

                            props({
                                'target button': `#target`
                            });
                        }

                    - an element that needs to be scrolled to

                        Generate page {
                            let body = ``;
                            for(let i = 0; i < 500; i++) {
                                body += `<div>foobar</div>`;
                            }
                            body += `
                                <button id="target" onmouseover="document.getElementById('display').innerHTML = 'I was hovered over'">hover over me</button>
                                <div id="display"></div>
                            `;
                            await setPageBody(body);

                            props({
                                'target button': `#target`
                            });
                        }
                ]
                    Hover over [target button]

                        Verify ['I was hovered over'] is visible

            - Scroll to
                [
                    - an element visible in the current viewport

                        Generate page {
                            await setPageBody(`
                                <div id="target">foobar</div>
                            `);

                            props({
                                'target': `#target`
                            });
                        }

                    - an element that needs to be scrolled to

                        Generate page {
                            let body = ``;
                            for(let i = 0; i < 500; i++) {
                                body += `<div>foobar</div>`;
                            }
                            body += `
                                <div id="target">foobar</div>
                            `;
                            await setPageBody(body);

                            props({
                                'target': `#target`
                            });
                        }
                ]
                    Scroll to [target]

                        Verify target is scrolled into view {
                            let isScrolledIntoView = await executeScript(function(elem) {
                                var rect = elem.getBoundingClientRect();
                                return (rect.top >= 0) && (rect.bottom <= window.innerHeight);
                            }, await $(`target`));

                            expect(isScrolledIntoView).to.be.true;
                        }

            - Get cookie

                Navigate to 'example.com'

                    - that exists

                        Set cookie 'foobar' to 'blah'

                            {cookie} = Get cookie 'foobar'

                                Verify cookie {
                                    expect(cookie.value).to.equal('blah');
                                }

                    - that doesn't exist

                        {cookie} = Get cookie 'badname'

                            - Verify above step fails #manual $s

            - Set cookie

                Navigate to 'example.com'

                    Set cookie 'foobar' to 'blah'

                        {cookie} = Get cookie 'foobar'

                            Verify cookie {
                                expect(cookie.value).to.equal('blah');
                            }

            - Set cookie with expiry

                Navigate to 'example.com'

                    Set cookie 'name1' to 'value1', expiring in '2' secs

                        {cookie} = Get cookie 'name1'

                            Verify cookie {
                                expect(cookie.value).to.equal('value1');
                            }

            - Delete cookie

                Navigate to 'example.com'

                    - Delete cookie that exists

                        Set cookie 'name1' to 'value1'

                            Delete cookie 'name1'

                                Verify cookie 'name1' was deleted

                    - Delete cookie that exists

                        Delete cookie 'name1'

                            Verify cookie 'name1' was deleted

            - Delete all cookies

                Navigate to 'example.com'
                    Set test cookies
                        Delete all cookies
                            Verify test cookies were deleted

            - Clear local storage

                Navigate to 'example.com'
                    Set test items in local storage
                        Clear local storage
                            Verify local storage was cleared

                        - Test that it doesn't clear the local storage for other domains

                            Set items in the local storage of a different domain [
                                Navigate to 'google.com'
                                    Set test items in local storage
                            ]
                                Navigate back to the original domain and clear its local storage [
                                    Navigate to 'example.com'
                                        Clear local storage
                                            Verify local storage was cleared
                                ]
                                    Navigate to the different domain and verify it wasn't cleared [
                                        Navigate to 'google.com'
                                            Verify local storage wasn't cleared
                                    ]

            - Clear cookies and local storage

                Navigate to 'example.com'
                    Set test cookies
                        Set test items in local storage

                            Clear cookies and local storage

                                Verify test cookies were deleted
                                    Verify local storage was cleared

            * Set test cookies [
                Set cookie 'name1' to 'value1'
                    Set cookie 'name2' to 'value2'
            ]

                * Verify test cookies were deleted [
                    Verify cookie 'name1' was deleted
                        Verify cookie 'name2' was deleted
                ]

            * Verify cookie {{name}} was deleted {
                let cookie = true;
                try {
                    cookie = await browser.driver.manage().getCookie(name);
                }
                catch(e) {
                    cookie = null;
                }

                expect(cookie).to.equal(null);
            }

            * Set test items in local storage {
                await executeScript(function() {
                    localStorage.setItem('name1', 'value1');
                    localStorage.setItem('name2', 'value2');
                });

                expect(await executeScript(function() {
                    return localStorage.getItem('name1');
                })).to.equal('value1');
            }

                * Verify local storage was cleared {
                    expect(await executeScript(function() {
                        return localStorage.getItem('name1');
                    })).to.equal(null);

                    expect(await executeScript(function() {
                        return localStorage.getItem('name2');
                    })).to.equal(null);
                }

                * Verify local storage wasn't cleared {
                    expect(await executeScript(function() {
                        return localStorage.getItem('name1');
                    })).to.equal('value1');

                    expect(await executeScript(function() {
                        return localStorage.getItem('name2');
                    })).to.equal('value2');
                }

            - Go back

                Navigate to 'example.com'
                    Navigate to 'google.com'
                        Go back
                            Verify at page 'example.com'

            - Go Forward

                - when there's a page in front

                    Navigate to 'example.com'
                        Navigate to 'google.com'
                            Go back
                                Go forward
                                    Verify at page 'google.com'

                - when there's no page in front

                    Navigate to 'example.com'
                        Go forward
                            Verify at page 'example.com'

            - Refresh

                Edit the page {
                    await setPageBody(`<div>Something else</div>`);
                }

                    Refresh

                        Verify the edits are no longer there + [
                            Verify ['Something else'] is not visible
                        ]

            - Type

                - a normal string of chars into a textbox

                - '[none]'

                - a string containing [special keys]
                    - such as '[enter]'
                    - and make sure it's case insensitive
                    - that's an invalid key
                    - that's '[]', which won't be treated as a special key

                - a string containing an escaped \[special key\]
                    - \[key\]
                    - [key\]
                    - \[key]
                    - multiple \[keys\]

            - Clear

            - Set
                - sets a value
                - does nothing if value is '[none]'

            - Check

                - a checkbox
                - a radio button

                    - that's unchecked

                        - and gets checked when clicked
                        - but refuses to get checked when clicked
                        - but is disabled

                    - that's already checked

            - Uncheck

                - a checkbox
                - a radio button

                    - that's checked

                        - and gets unchecked when clicked
                        - but refuses to get unchecked when clicked
                        - but is disabled

                    - that's already unchecked

            - Select

                - from a <select>
                - from a custom dropdown made from <div>'s

                    - where the value being matched
                        - exactly matches the item in the dropdown
                        - doesn't exactly match the item in the dropdown, but matches in a contains/trimmed/case-insensitive search

                            - and only one item matches
                            - and multiple items match

                                - Verify that the correct item is selected
                                    - and the dropdown is closed
                                        - and that the correct log items are present in the report #manual -s

                - where the value is '[none]'
                    - Verify nothing happens

            - Select element

                - from a <select>
                - from a custom dropdown made from <div>'s

                    - and only one item matches
                    - and multiple items match

                        - Verify that the correct item is selected
                            - and the dropdown is closed
                                - and that the correct log items are present in the report #manual -s

                - where the value is '[none]'
                    - Verify nothing happens

            - Current url
                - when the browser is at
                    - a normal url
                    - a newly opened blank tab

            - Window title

            - Value of
                - an element with a value
                - an element without a value

        - Category: Window

            - Set dimensions

            - Maximize window

            - Open new tab

            - Switch to window whose title contains
                - and a window with that title
                    - exists
                    - doesn't exist

            - Switch to a window whose url contains
                - and a window with that url
                    - exists
                    - doesn't exist

            - Switch to the nth window
                - and a window at that index
                    - exists
                    - doesn't exist
                - and nth is not set to a number

            - Switch to iframe

            - Switch to topmost iframe

        - Category: Alerts

            - Accept alert

            - Dismiss alert

            - Verify alert contains

        - Category: Network conditions and throttling

            - Offline
            - Online
            - Network latency
            - No network latency
            - Maxmium download speed
            - No maximum download speed
            - Maximum upload speed
            - No maximum upload speed

                - If Chrome
                    - Manually verify #manual $s
                - If not Chrome
                    - Manually verify nothing happens and proper logs made in report #manual $s

        - Category: Mocks

            - Mock time

                - with valid Date object
                - with valid Date string

                    - Verify date set

                - with invalid Date string
                    - Verify error

            - Mock location to latitude and longitude

            - Mock location to location
                - with valid city name
                - with invalid city name

            - Stop all mocks

        - Category: Verify

            - Verify at page
                - and the title contains the given text
                - and the url contains the given text
                - and neither the title nor the url contain the given text

            - Verify cookie contains

                - where the cookie with the given name

                    - doesn't exist

                    - exists
                        - and contains the given value
                        - and doesn't contain the given value

            - Verify element is visible

            - Verify element is not visible

        - Category: Wait until

            - Wait until at page
            - Wait until at page (up to n secs)
            - Wait until cookie contains
            - Wait until cookie contains (up to n secs)
            - Wait until element is visible
            - Wait until element is visible (up to n secs)
            - Wait until element is not visible
            - Wait until element is not visible (up to n secs)

                - Manually verify the longer timeout #manual $s

        - Category: Wait

            - Wait '1' second
            - Wait n seconds

        - Category: Print and Log

            - Log
                - A plain string
                - With vars in string

            - [EF] $s #manual
